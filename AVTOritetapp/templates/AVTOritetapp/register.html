{% extends 'AVTOritetapp/base.html' %}
{% load static %}

{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Äî AVTOritet{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'AVTOritetapp/css/login.css' %}">
<style>
.login-page {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: var(--light);
    padding-top: 60px;
    padding-bottom: 60px;
}

.login-container {
    max-width: 400px;
    width: 100%;
    margin-top: 40px;
    margin-bottom: 40px;
}

.form-group {
    margin-bottom: 15px;
    width: 100%;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    box-sizing: border-box;
}

.password-wrapper {
    position: relative;
}

.password-wrapper input {
    padding-right: 40px;
}

.toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    padding: 0;
}

.login-btn {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
}

.availability-message, #username-status {
    margin-top: 5px;
    font-size: 13px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
.alert {
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 4px;
}

.alert-success {
    color: #3c763d;
    background-color: #dff0d8;
    border-color: #d6e9c6;
}

.alert-error, .alert-danger {
    color: #a94442;
    background-color: #f2dede;
    border-color: #ebccd1;
}

.alert-info {
    color: #31708f;
    background-color: #d9edf7;
    border-color: #bce8f1;
}

.spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 2s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#preloader {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
}

#preloader div {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    text-align: center;
}
</style>
{% endblock %}

{% block content %}
<div class="login-page">
  <div class="login-container">
    <h2 style="margin-bottom: 30px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>

    {# –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–∞—Ö #}
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}">
          {{ message }}
          {% if '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è' in message|lower and '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' in message|lower %}
            <p style="margin-top: 10px;">–ù–µ –ø–æ–ª—É—á–∏–ª–∏ –ø–∏—Å—å–º–æ? <a href="#" id="resend-email">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ</a></p>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}

    <form method="POST" id="register-form">
      {% csrf_token %}

      <div class="form-group">
        <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <input type="text" name="username" id="username" class="form-control" required>
        <div id="username-status" class="availability-message"></div>
        {% if form.username.errors %}
          <div class="error">{{ form.username.errors }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="email">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
        <input type="email" name="email" id="email" class="form-control" required>
        {% if form.email.errors %}
          <div class="error">{{ form.email.errors }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="password1">–ü–∞—Ä–æ–ª—å</label>
        <div class="password-wrapper">
          <input type="password" name="password1" id="password1" class="form-control" required>
          <button type="button" class="toggle-password" onclick="togglePasswordVisibility('password1', this)">üëÅ</button>
        </div>
        {% if form.password1.errors %}
          <div class="error">{{ form.password1.errors }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="password2">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
        <div class="password-wrapper">
          <input type="password" name="password2" id="password2" class="form-control" required>
          <button type="button" class="toggle-password" onclick="togglePasswordVisibility('password2', this)">üëÅ</button>
        </div>
        {% if form.password2.errors %}
          <div class="error">{{ form.password2.errors }}</div>
        {% endif %}
      </div>

      <button type="submit" class="login-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </form>

    <p style="margin-top: 20px;">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="{% url 'login' %}" class="secondary-link">–í–æ–π—Ç–∏</a></p>
  </div>
</div>

<!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä -->
<div id="preloader">
    <div>
        <div class="spinner"></div>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
</div>

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function togglePasswordVisibility(inputId, button) {
    const passwordInput = document.getElementById(inputId);
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        button.textContent = 'üëÅ‚Äçüó®';
    } else {
        passwordInput.type = 'password';
        button.textContent = 'üëÅ';
    }
}

$(document).ready(function() {
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    function checkUsernameDeferred(username) {
        var deferred = $.Deferred();

        $('#preloader').show();

        setTimeout(function() {
            $.ajax({
                url: '/check_username/',
                type: 'GET',
                data: { username: username },
                dataType: 'json'
            })
            .then(function(response) {
                if(response.is_taken) {
                    deferred.reject("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ");
                } else {
                    deferred.resolve("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ");
                }
            }, function() {
                deferred.reject("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ");
            })
            .always(function() {
                $('#preloader').hide();
            });
        }, 1000);

        return deferred.promise();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    $('#username').on('blur', function() {
        var username = $(this).val().trim();

        if(username.length >= 3) {
            checkUsernameDeferred(username)
                .then(function(message) {
                    $('#username-status').html('<span style="color:green">‚úì ' + message + '</span>');
                }, function(error) {
                    $('#username-status').html('<span style="color:red">‚úñ ' + error + '</span>');
                });
        } else {
            $('#username-status').html('');
        }
    });

    // –£–ª—É—á—à–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞
    $(document).on('click', '#resend-email', function(e) {
        e.preventDefault();
        var $emailField = $('#email');
        var email = $emailField.val().trim();

        if (!email) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ email, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
            $emailField.focus();
            return;
        }

        $('#preloader').show();

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º try-catch –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫ —à–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä–∞
        try {
            var url = '{% url "resend_verification" %}'; // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å url-—Ö–µ–ª–ø–µ—Ä

            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    email: email,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if(response && response.status === 'success') {
                        alert('–ü–∏—Å—å–º–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞ ' + email);
                    } else {
                        alert(response.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–∏—Å—å–º–∞');
                    }
                },
                error: function(xhr) {
                    var errorMsg = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–∏—Å—å–º–∞';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    alert(errorMsg);
                },
                complete: function() {
                    $('#preloader').hide();
                }
            });
        } catch (error) {
            $('#preloader').hide();
            console.error('–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞:', error);
            alert('–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π');
        }
    });
});
</script>
{% endblock %}
{% endblock %}